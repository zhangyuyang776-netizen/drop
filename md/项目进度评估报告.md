# 多组分液滴无化学数值框架 - 项目进度评估报告

**评估日期**: 2025-12-16
**评估范围**: Step 0 - Step 12（阶段A：Windows + SciPy）
**参照路线**: `md/多组分液滴无化学数值框架工作路线.md`

---

## 执行摘要

### 整体进度估计：**约 65-70%**

根据对照工作路线Step 0-12的要求，项目在核心框架、单相传输、界面耦合方面取得了显著进展，但**多组分耦合系统**（特别是气相Yg和液相Yl的完整集成）尚未完成。

**关键成就**：
- ✅ 完成了清晰的数据结构与索引系统（types.py, layout.py, grid.py）
- ✅ 完成了气/液物性计算框架（Cantera + CoolProp）
- ✅ 完成了气相能量方程（Tg + Stefan对流）
- ✅ 完成了液相导热方程（Tl）
- ✅ 完成了界面能量/质量平衡（Ts, mpp, Rd）
- ✅ 完成了时间推进器（timestepper）骨架

**主要缺口**：
- ❌ **气相多组分（Yg）未耦合进统一系统**
- ❌ **液相多组分（Yl）完全未实现**
- ❌ **扩散焓（diffusion enthalpy）未实现**
- ❌ PETSc后端未实现（计划中）
- ❌ 化学反应未实现（计划中）

---

## 详细进度分析

### 阶段 A.0：总体约束 ✅ **100%**

**状态**: 已完成

**已实现**：
1. ✅ 索引只从 `UnknownLayout` 获取（`core/layout.py`）
2. ✅ 物性只在 `Props` 中（`core/types.py`）
3. ✅ 组装只写 `A, b`，不直接改 `State`（`assembly/build_system_SciPy.py`）
4. ✅ 线性求解器后端抽象（`solvers/scipy_linear.py`）

**验证**：
- `core/layout.py` 提供完整的 `idx_Tg()`, `idx_Yg()`, `idx_Tl()` 等索引方法
- 所有物性计算在 `properties/` 模块，输出统一到 `Props` 对象
- 组装模块使用 numpy 数组构建 A, b，不修改 State

---

### Step 1: `core/types.py` ✅ **100%**

**状态**: 已完成

**已实现**：
- ✅ `CaseConfig`: 完整的配置数据结构（包含 case/paths/geometry/time/physics/species 等）
- ✅ `Grid1D`: 网格结构（r_c, r_f, V_c, A_f, iface_f, liq_slice, gas_slice）
- ✅ `State`: 状态变量（Tg, Yg, Tl, Yl, Ts, mpp, Rd）
- ✅ `Props`: 物性（rho_g, cp_g, k_g, D_g, rho_l, cp_l, k_l, D_l）
- ✅ 验证函数：`check_sumY()`, `check_nonneg()`, `check_positive_props()`

**代码位置**: `core/types.py` (521 lines)

---

### Step 2: `core/layout.py` ✅ **100%**

**状态**: 已完成

**已实现**：
- ✅ `UnknownLayout`: 统一未知量布局
  - 支持 Tg, Yg, Tl, Yl, Ts, mpp, Rd 的索引
  - 气/液物种的闭合策略（去除闭合物种，由 ΣY=1 重构）
- ✅ `pack_state()`: State → 向量
- ✅ `apply_u_to_state()`: 向量 → State（含闭合物种重构）
- ✅ 单元测试：`assert_pack_apply_consistency()`

**代码位置**: `core/layout.py` (514 lines)

**备注**: layout 支持多组分，但 timestepper 中尚未启用 Yg/Yl 块。

---

### Step 3: `core/grid.py` ✅ **100%**

**状态**: 已完成

**已实现**：
- ✅ `Grid1D` 数据结构（在 types.py 中定义）
- ✅ 球对称网格生成逻辑（`core/grid.py`）
  - 支持液相/气相分段
  - 支持多种网格分布（uniform, geometric, tanh）
  - 界面连续性检查
- ✅ 几何验证：体积/面积/半径单调性

**代码位置**: `core/grid.py`

**测试**: `tests/test_grid_interface_continuity.py`

---

### Step 4: `properties/equilibrium.py` ✅ **100%**

**状态**: 已完成

**已实现**：
- ✅ 界面平衡接口定义
- ✅ Raoult定律 + CoolProp psat 计算
- ✅ 背景气填充策略（farfield fill）
- ✅ 输出：`Yg_eq`, `y_cond`, `psat`

**代码位置**: `properties/equilibrium.py`

**测试**: `tests/test_equilibrium.py`

---

### Step 5: 物性模块 ✅ **100%**

**状态**: 已完成

**已实现**：

#### `properties/gas.py`
- ✅ Cantera 气相物性计算
- ✅ 输出：`rho_g`, `cp_g`, `k_g`, `D_g` (多组分扩散系数)
- ✅ 额外输出：`h_g`, `h_gk` (焓)

#### `properties/liquid.py`
- ✅ CoolProp 液相物性计算
- ✅ 输出：`rho_l`, `cp_l`, `k_l`
- ✅ 额外输出：`psat_l`, `hvap_l` (饱和蒸气压、蒸发焓)

#### `properties/aggregator.py`
- ✅ 统一物性计算入口：`build_props_from_state()`
- ✅ 整合气相、液相物性到 `Props` 对象
- ✅ 管理额外输出（extras）

**测试**:
- `tests/test_gas_properties.py`
- `tests/test_liquid_properties.py`
- `tests/test_properties_aggregator.py`

---

### Step 6: 气相标量扩散 ✅ **100%**

**状态**: 已完成

**已实现**：
- ✅ `assembly/build_system_SciPy.py`: 气相温度 Tg 的扩散方程
  - 完全隐式时间项 (theta=1.0)
  - 内边界：零梯度（Neumann）
  - 外边界：强 Dirichlet (T=T_inf)
- ✅ `solvers/scipy_linear.py`: SciPy 线性求解器封装

**测试**:
- `tests/test_step6_scipy_transport.py`
- `tests/test_scalar_diffusion_integration.py`

---

### Step 7: `physics/flux_gas.py` ✅ **100%**

**状态**: 已完成

**已实现**：
- ✅ `compute_gas_diffusive_flux_T()`: 气相导热通量
- ✅ `compute_gas_diffusive_flux_Y()`: 气相物种扩散通量
- ✅ 统一符号约定：outward positive

**测试**:
- `tests/test_flux_gas.py`
- `tests/test_flux_gas_species_diff.py`

---

### Step 8: Stefan 速度 + 对流 ✅ **100%**

**状态**: 已完成

**已实现**：

#### `physics/stefan_velocity.py`
- ✅ Stefan 速度计算：`u(r) = mpp * Rd² / (ρ_g * r²)`
- ✅ face 速度插值

#### `physics/flux_convective_gas.py`
- ✅ `compute_gas_convective_flux_T()`: 气相温度对流通量
- ✅ `compute_gas_convective_flux_Y()`: 气相物种对流通量
- ✅ Upwind 格式

#### `assembly/build_system_SciPy.py` 升级
- ✅ 集成 Stefan 对流项（显式处理）

**测试**:
- `tests/test_step8_scipy_transport.py`
- `tests/test_flux_convective_gas.py`
- `tests/test_flux_convective_gas_species.py`

---

### Step 9: 气相单物种方程 ⚠️ **70%**

**状态**: **部分完成 - 模块已实现但未集成**

**已实现**：
- ✅ `assembly/build_species_system_SciPy.py`: 单物种 Yg 方程
  - 隐式扩散 (ρD)
  - 显式 Stefan 对流
  - 外边界 Dirichlet (Y=0)
- ✅ 单独测试通过

**未完成**：
- ❌ **未集成到 timestepper 中**
- ❌ **未与 Tg 方程耦合成统一系统**
- ❌ 多物种全耦合（Ns_g 个方程同时求解）

**测试**: `tests/test_step9_scipy_species.py` (仅单物种独立测试)

**影响**: 当前 timestepper 只推进 Tg+Ts+mpp+Rd+Tl，**Yg 未参与时间演化**。

---

### Step 10: 液相导热 ✅ **100%**

**状态**: 已完成

**已实现**：
- ✅ `physics/flux_liq.py`: 液相导热通量
- ✅ `assembly/build_liquid_T_system_SciPy.py`: 液相温度方程
  - 内边界：中心对称（r=0）
  - 界面边界：两种模式
    - 固定 Ts (Dirichlet)
    - 耦合模式（与 Ts 方程联立，Step 11+ 使用）
- ✅ 集成到 timestepper（耦合模式）

**测试**: `tests/test_step10_scipy_liquid_T.py`

---

### Step 11: 界面条件（Ts/mpp/Rd） ✅ **95%**

**状态**: 基本完成

**已实现**：

#### `physics/interface_bc.py`
- ✅ 界面能量跳跃方程（Ts）
  - 气相导热 + 液相导热 + 潜热平衡
- ✅ 质量通量方程（mpp）
  - 单组分 Stefan 条件
  - 基于平衡组分 `Yg_eq` 和扩散通量

#### `physics/radius_eq.py`
- ✅ 液滴半径演化方程（Rd）
  - 后向欧拉：`dRd/dt = -mpp / rho_l_if`
  - 与 mpp 耦合

**测试**:
- `tests/test_interface_balance.py`
- `tests/test_radius_eq.py`

**未完成**：
- ❌ **扩散焓（diffusion enthalpy）项未实现**
  - 当前界面能量方程仅含导热 + 潜热
  - 缺少 `Σ h_k J_k` 贡献（多组分扩散焓）
- ❌ 多组分 Stefan 条件（目前仅支持单组分凝结）

---

### Step 12: 时间推进器 ✅ **85%**

**状态**: 骨架完成，部分物理缺失

**已实现**：

#### `solvers/timestepper.py`
- ✅ `advance_one_step_scipy()`: 单步推进
  - Stage 1: 解 Tg + Tl + Ts + mpp + Rd（耦合模式）
  - 调用 `build_transport_system()` 组装
  - 调用 `solve_linear_system_scipy()` 求解
  - 解包回 State
- ✅ 诊断输出：`StepDiagnostics`
  - 线性求解收敛信息
  - 关键状态量（Ts, Rd, mpp, Tg_min/max）
  - 界面/半径平衡检查
- ✅ 输出写入：`io/writers.py`

**测试**: `tests/test_timestepper_one_step.py`

**未完成**：
- ❌ **Yg 未参与时间演化**（虽然 layout 支持，但未启用）
- ❌ **Yl 完全未实现**
- ❌ 物性更新：当前 props 视为 quasi-steady（未在步内重算）
- ❌ 动网格：Rd 变化后，网格未重构

---

## 核心问题分析

### 问题 1: 气相多组分（Yg）未完全落实 ⚠️

**现状**：
- `build_species_system_SciPy.py` **已实现**单物种方程
- `layout.py` **已支持** Yg 的索引和打包
- 但 `timestepper.py` 和 `build_transport_system()` **未启用** Yg

**原因**：
- 当前 `build_transport_system()` 仅组装 Tg + Ts + mpp + Rd + Tl
- Yg 方程需要：
  1. 扩展 layout 为完整多物种（包含所有 Ns_g_eff 个 Yg 未知量）
  2. 在 `build_transport_system()` 中调用物种方程组装
  3. 将 Tg 和 Yg 方程合并为统一大系统

**影响**：
- 气相组分在时间演化中**保持初值不变**
- 无法模拟蒸发导致的气相组分分布变化

**剩余工作量**：约 **15-20%**
- 修改 `build_transport_system()` 以包含 Yg 块
- 在 `timestepper` 中启用 Yg 更新
- 全系统测试

---

### 问题 2: 液相多组分（Yl）完全未实现 ❌

**现状**：
- `State.Yl` 字段**存在**（占位）
- `layout.py` **已支持** Yl 索引
- 但**无任何 Yl 传输方程**

**缺失模块**：
- ❌ `physics/flux_liq_species.py`（液相物种扩散通量）
- ❌ `assembly/build_liquid_species_system_SciPy.py`（液相物种方程）
- ❌ 液相多组分物性（D_l）

**影响**：
- 液滴内部组分分布**无法演化**
- 多组分液滴蒸发问题**无法模拟**

**剩余工作量**：约 **20-25%**
- 实现液相物种扩散通量
- 实现液相物种方程组装
- 液相多组分物性计算（CoolProp 或简化模型）
- 集成到 timestepper

---

### 问题 3: 扩散焓（Diffusion Enthalpy）未实现 ❌

**现状**：
- 当前界面能量方程：`q_g + q_l + m'' h_vap = 0`
- **缺少**：`Σ h_k J_k` 项（多组分扩散焓贡献）

**影响**：
- 多组分蒸发时，界面能量平衡**不完整**
- 对于显著组分扩散的情况，Ts 预测**可能有偏差**

**剩余工作量**：约 **5-8%**
- 在 `physics/interface_bc.py` 中添加扩散焓项
- 需要 `h_gk`（已在 `properties/gas.py` 输出）
- 需要 `J_k`（扩散通量，气/液两侧）

---

## 项目进度总结表

| Step | 模块 | 进度 | 状态 | 备注 |
|------|------|------|------|------|
| A.0 | 总体约束 | 100% | ✅ | 完成 |
| 1 | `core/types.py` | 100% | ✅ | 完成 |
| 2 | `core/layout.py` | 100% | ✅ | 完成 |
| 3 | `core/grid.py` | 100% | ✅ | 完成 |
| 4 | `properties/equilibrium.py` | 100% | ✅ | 完成 |
| 5 | `properties/gas.py`, `liquid.py`, `aggregator.py` | 100% | ✅ | 完成 |
| 6 | `assembly/build_system_SciPy.py` (Tg 扩散) | 100% | ✅ | 完成 |
| 7 | `physics/flux_gas.py` | 100% | ✅ | 完成 |
| 8 | Stefan 速度 + 对流 | 100% | ✅ | 完成 |
| 9 | 气相单物种 Yg | **70%** | ⚠️ | 模块完成但未集成 |
| 10 | 液相导热 Tl | 100% | ✅ | 完成 |
| 11 | 界面条件（Ts/mpp/Rd） | **95%** | ⚠️ | 缺少扩散焓 |
| 12 | 时间推进器 | **85%** | ⚠️ | Yg/Yl 未参与 |
| **总体** | **Step 0-12** | **65-70%** | ⚠️ | 核心框架完成，多组分集成缺失 |

---

## 已完成的核心能力

### ✅ 可以运行的物理场景

基于当前代码，**可以模拟**：

1. **单组分液滴蒸发**（固定气相组分）
   - 气相温度演化（Tg + Stefan 对流 + 扩散）
   - 液相温度演化（Tl + 导热）
   - 界面温度（Ts）动态求解
   - 蒸发质量通量（mpp）动态求解
   - 液滴半径收缩（Rd）

2. **物性耦合**
   - Cantera 气相物性（ρ, cp, k, D）
   - CoolProp 液相物性（ρ, cp, k, psat, hvap）

3. **时间推进**
   - 固定时间步长
   - 隐式扩散 + 显式 Stefan 对流
   - 线性系统求解（SciPy）

### ❌ 无法运行的物理场景

**无法模拟**：

1. **多组分液滴蒸发**
   - 气相组分演化（Yg 未参与时间演化）
   - 液相组分演化（Yl 完全未实现）

2. **优先蒸发/选择性蒸发**
   - 需要 Yg 和 Yl 的完整耦合

3. **复杂界面能量平衡**
   - 缺少扩散焓项

---

## 剩余工作路线

### 优先级 1: 完成多组分耦合（Yg 集成） 🔴

**目标**: 使 Yg 参与时间演化

**任务**：
1. 修改 `build_transport_system()`:
   - 在 Tg 方程后添加 Yg 方程块
   - 调用 `build_species_system()` 为每个物种生成方程
   - 组装为统一大系统
2. 修改 `timestepper.py`:
   - 启用 Yg 块解包
   - 确保闭合物种重构
3. 测试：
   - 多组分气相传输测试
   - ΣY=1 守恒检查

**预估工作量**: 2-3天

---

### 优先级 2: 实现液相多组分（Yl） 🔴

**目标**: 实现 Yl 传输方程

**任务**：
1. 实现 `physics/flux_liq_species.py`
2. 实现 `assembly/build_liquid_species_system_SciPy.py`
3. 液相多组分物性（D_l）
4. 集成到 `build_transport_system()`
5. 测试液相组分守恒

**预估工作量**: 3-5天

---

### 优先级 3: 添加扩散焓 🟡

**目标**: 完善界面能量方程

**任务**：
1. 在 `interface_bc.py` 中添加 `Σ h_k J_k` 项
2. 使用已有的 `h_gk` 和扩散通量 `J_k`
3. 测试界面能量守恒

**预估工作量**: 1-2天

---

### 优先级 4: 物性更新策略 🟢

**目标**: 在时间步内更新物性

**任务**：
1. 在 `advance_one_step_scipy()` 中添加物性重算
2. 可选：迭代更新（简单不动点迭代或 quasi-Newton）

**预估工作量**: 1-2天

---

### 优先级 5: 动网格 🟢

**目标**: 根据 Rd 变化重构网格

**任务**：
1. 在 `core/grid.py` 添加网格重构函数
2. 在 timestepper 每步后调用重构
3. 处理状态量的网格映射（插值）

**预估工作量**: 2-3天

---

## 代码质量评价

### ✅ 优点

1. **架构清晰**：
   - 严格遵循"索引来自 layout、物性在 Props、组装只写 A/b"
   - 模块分层合理（core / properties / physics / assembly / solvers）

2. **可测试性好**：
   - 大部分模块有单元测试
   - 物理模块独立可测（flux_gas, stefan_velocity 等）

3. **类型安全**：
   - 使用 dataclass 和类型注解
   - 数据结构定义清晰

4. **可扩展性强**：
   - layout 设计支持任意组合的未知量
   - 易于添加新物理方程

### ⚠️ 待改进

1. **集成度不足**：
   - 已实现的模块（如 `build_species_system_SciPy.py`）未被主流程使用

2. **文档不足**：
   - 部分模块缺少使用示例
   - 测试覆盖率待提升（特别是集成测试）

3. **性能优化待做**：
   - 当前使用稠密矩阵（可改为稀疏矩阵）
   - 物性计算可缓存

---

## 建议的下一步行动

### 短期（1-2周）

1. **完成 Yg 集成** ⭐⭐⭐
   - 修改 `build_transport_system()` 包含 Yg 方程
   - 在 `timestepper` 中启用 Yg 更新
   - **目标**: 能够运行多组分气相传输测试算例

2. **添加完整测试案例**
   - 创建一个多组分液滴蒸发算例（NC12 + PMH 混合）
   - 运行完整时间演化（即使 Yl 未实现）
   - 验证 Tg, Yg, Ts, mpp, Rd 演化趋势

### 中期（3-4周）

3. **实现 Yl 方程** ⭐⭐
   - 实现液相物种扩散通量和方程
   - 集成到统一系统

4. **添加扩散焓** ⭐
   - 完善界面能量方程

5. **稳定性和诊断**
   - 添加守恒量检查（质量、能量）
   - 改进诊断输出

### 长期（1-2个月）

6. **迁移到 PETSc** (阶段 B)
   - 实现 PETSc 后端
   - 在 Linux 环境测试

7. **添加化学反应** (阶段 C)
   - 接入 Cantera 化学源项
   - Strang 拆分时间推进

---

## 结论

当前项目在**框架和单相传输**方面取得了扎实进展，已完成约 **65-70%** 的阶段 A 工作。核心架构（types/layout/grid）、物性计算、气相能量方程、液相导热、界面耦合（Ts/mpp/Rd）均已实现并通过测试。

**主要缺口**在于**多组分的完整集成**：
- 气相多组分（Yg）模块已实现但未集成到时间推进器
- 液相多组分（Yl）完全未实现

建议**优先完成 Yg 集成**（预计 2-3 天工作量），使项目能够运行真正的多组分气相传输算例，然后再推进 Yl 实现和扩散焓等完善工作。

项目代码质量良好，架构清晰，为后续扩展（PETSc、化学反应）奠定了坚实基础。

---

**报告生成时间**: 2025-12-16
**评估者**: Claude (AI Assistant)
**参考文档**:
- `md/多组分液滴无化学数值框架工作路线.md`
- `md/阶段总结.md`
- 代码库检查（`/home/user/drop/`）
