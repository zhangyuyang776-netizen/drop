先把话说明白：这一步就是给以后的自己拧螺丝用的，不准谁再随手改符号导致 m'' 一会儿蒸发一会儿凝结。

下面是**“方向与符号统一约定说明（无化学源项版）”**，你可以直接存成
`Direction_Convention_NoChem.md` 丢给 Codex 当圣旨。

---

# 多组分液滴数值框架 · 方向与符号统一约定（无化学源项）

> 依据：
>
> * `Droplet_Transport_Framework_NoChemistry.md`（物理“宪法”）
> * `NewProject_Guide_NoChem_PETSc.md`（新项目实现规范）
>   目标：保证所有模块（尤其是 `physics/interface_bc.py`、`radius_eq.py`、`transport`、`assembly`）在**方向、法向、通量符号**上的统一。

---

## 1. 坐标与法向总约定

1. 几何与坐标

   * 1D 球对称，径向坐标：**r**
   * 液滴中心：r = 0
   * 液相区域：0 ≤ r ≤ R_d(t)
   * 气相区域：R_d(t) ≤ r ≤ R_∞

2. 法向向量 n

   * 全局唯一约定：
     [
     \mathbf{n} = +\mathbf{e}_r
     ]
   * 含义：**从液滴指向外界**（从中心指向远场）。
   * 所有“·n”的投影分量都以这个方向为正。

3. “流出为正”的约定【在 NewProject 总结里也写死了】

   * 对任意控制体积（cell / 界面）：

     * **沿 +r、穿出该控制体的通量为正**。
   * 这条适用于：

     * 质量通量（m''、J）
     * 热通量（q）
     * 对流通量（ρ v φ）

---

## 2. 气相物种通量 J_g,k 的方向约定

1. 定义

   * 气相物种 k 的扩散通量：
     [
     J_{g,k}(r,t) \quad\text{沿}\ n=\mathbf{e}_r\ \text{的分量}
     ]
   * **正方向为从液滴指向外界**。
   * 在控制方程中的形式（球对称）为：
     [
     \rho_g \frac{\partial Y_{g,k}}{\partial t}

     * \frac{1}{r^2}\frac{\partial}{\partial r}(\rho_g v Y_{g,k} r^2)
       = -\frac{1}{r^2}\frac{\partial}{\partial r}(J_{g,k} r^2)
       ]
       右侧是扩散通量的散度项【框架文件中已约定】。

2. 物理解释

   * `J_g,k > 0`：物种 k 的**净扩散**从内向外（往远场方向）流动。
   * 在界面残差中，统一使用 `J_g,k · n`，即上述标量。

3. 离散实现要求

   * 面通量统一写成：
     [
     F_{g,k,f} = J_{g,k,f} , A_f
     ]
     其中 `A_f` 为面朝 +r 的面积，**不带符号**。
   * 在 `assembly` 中对某个 cell 的残差，采用“流出为正”标准：
     [
     R_{Y,k,cell} \supset \sum_{faces} F_{g,k,f}^{,\text{(流出)}}
     ]
   * `transport` / `grad` 负责构造 `J_g,k`，`assembly` 只做几何乘法和符号统一，不自行改向。

---

## 3. 气相热通量 q_g 的方向约定

1. 定义

   * 气相热通量：
     [
     q_g = -\lambda_g \frac{\partial T_g}{\partial r}
     ]
   * **q_g > 0 表示热量沿 +r（从液滴指向外界）流动**。
   * 能量方程（总焓形式）写成：
     [
     \rho_g \frac{\partial h_g}{\partial t}

     * \frac{1}{r^2}\frac{\partial}{\partial r}(\rho_g v h_g r^2)
       = -\frac{1}{r^2}\frac{\partial}{\partial r}(q_g r^2) + \Phi_{\text{diff-h}}
       ]

2. 离散实现要求

   * 面热通量：
     [
     Q_{g,f} = q_{g,f} A_f
     ]
   * 残差中仍采用“**流出为正**”：

     * 对某个气相 cell：
       [
       R_{h_g,cell} \supset \sum_{faces} Q_{g,f}^{,\text{(流出)}}
       ]
   * `q_g` 的方向完全由导数定义 + `-λ_g` 决定，**禁止在后续模块再加手动负号**。

---

## 4. 液相热通量 q_l 与物种通量 J_l

1. 定义

   * 液相也采用同样的径向坐标与法向：
     [
     q_l = -\lambda_l \frac{\partial T_l}{\partial r}
     ]
   * **q_l > 0** 表示热从液滴内部向界面方向（+r）流动。

2. 物种通量（若有多组分液滴）

   * 定义与气相同：
     [
     J_{l,k} > 0 \iff \text{物种 k 沿 +r 从内部指向界面}
     ]

3. 面通量与残差

   * 面通量：`Q_l,f = q_l,f A_f`，`F_{l,k,f} = J_{l,k,f} A_f`
   * 液相 cell 残差同样统一使用“流出为正”。

---

## 5. 界面质量通量 m'' 的方向约定

1. 定义

   * `m''` 为**界面总质量通量**的标量，单位 kg/(m²·s)：

     * **m'' > 0：蒸发（从液相流向气相）**
     * m'' < 0：凝结（从气相流向液相）

2. 与 J_g,k 的关系（Droplet_Transport 中的残差形式）

   * 一种常用写法（总通量形式）：
     [
     R_{\text{mass,if}} = \sum_k J_{g,k} \cdot n + m'' = 0
     ]
   * 解释：

     * `Σ J_g,k·n`：所有物种在界面处的气相扩散通量之和（向外为正）
     * `m''`：从液相“喷”进气相的总质量通量（向外为正）
     * 质量守恒要求：两者相加为零（气相看见的是扩散 + 对流结果，和从界面吹出来的一致）。

3. 数值实现要求（接口 / interface_bc.py）

   * 在 `interface_bc` 中，任何用到 m'' 的方程都必须遵守：

     * `mpp > 0` ⇔ 蒸发
     * `J_g,k·n` 与 `m''` 在符号上要能满足上面的残差形式。
   * 不允许在某模块里把 m'' 当作“从气相指向液相”为正，再用“脑内记号转换”。

---

## 6. 界面能量跳跃条件的符号约定

1. 连续框架中的界面能量平衡（已在框架文件中给出）可写成类似形式：
   [
   q_l \cdot n ;-; q_g \cdot n ;+; \sum_k h_{k,g} J_{g,k} \cdot n ;-; m'' h_{\text{vap}} = 0
   ]

   解释每一项的物理含义：

   * `q_l·n`：

     * 液相内部沿 +r 传到界面的热流
     * > 0：**液相向界面/气相提供的热量**
   * `- q_g·n`：

     * 气相一侧把热从界面往外带走
     * 原式中采用 `q_l·n - q_g·n` 形式，相当于“液进 − 气出”
   * `Σ h_k,g J_g,k·n`：

     * 物种扩散携带的焓通量，正向同样是指向外界
   * `- m'' h_vap`：

     * 蒸发潜热需求，若 m'' > 0（蒸发），此项为负，表示要从界面体系中“吃掉”能量

   整体为 0 就是：

   > 液相给界面的热 − 气相带走的热 + 扩散带着走/带回来的焓 − 蒸发需要的潜热 = 0。

2. 接口层实现要求（给 `physics/interface_bc.py` 用的死规矩）

   在 interface_bc 的“Ts 方程”/“界面能量残差”行里：

   * 必须严格沿用 `q_l·n - q_g·n + Σ h_k J_g,k·n - m'' h_vap = 0` 这一符号结构；
   * `q_l`、`q_g`、`J_g,k` 都必须使用各自模块中已经按“+r为正”约定好的方向，不再反向；
   * m'' 的正号含义仍为“液 → 气”，不可在这里改口。

   换句话说：

   * 实现时可以改变离散形式（差分、插值），但**不能改变这四个项之间的符号组合**。

---

## 7. 液滴半径 R_d 的方向与演化方程

1. 几何意义

   * R_d(t) 是液滴半径，非负标量；
   * dR_d/dt 的符号代表界面沿 +r 的运动方向：

     * dR_d/dt < 0：界面向中心收缩（蒸发占主导）
     * dR_d/dt > 0：界面向外膨胀（冷却收缩/热膨胀等其他效应）

2. 与 m'' 的耦合（来自质量守恒）
   在 Droplet_Transport 框架中，球对称下总质量守恒可以写成：
   [
   \frac{d}{dt}\left(\frac{4}{3}\pi R_d^3 \bar{\rho}_l \right)
   = - 4\pi R_d^2 m''
   ]

   若短时间内液相密度近似常数，可化为：
   [
   \frac{dR_d}{dt} = - \frac{m''}{\bar{\rho}_l}
   ]

   这直接给出**符号关系**：

   * 若 m'' > 0（蒸发）：

     * dR_d/dt < 0，液滴半径减小
   * 若 m'' < 0（凝结）：

     * dR_d/dt > 0，液滴膨胀

3. `radius_eq.py` 实现要求

   在 `physics/radius_eq.py` 中构建 R_d 的离散方程时，必须保证：

   * 半隐式/全隐式离散的形式虽然可以变化，但最终解出来的 R_d 演化要满足上面这条符号关系；
   * 在残差形式中，m'' 的位置与符号要与界面质量残差保持一致，不允许“这里取负号那边再补回来”。

---

## 8. 对流速度 v(r) 的方向约定（Stefan 流）

1. 定义

   * 气相径向速度 v(r) 源自总质量连续方程及界面质量通量 m''，在 Droplet_Transport 中近似推导为：
     [
     \rho_g v r^2 = m'' R_d^2
     \quad\Rightarrow\quad
     v(r) = \frac{m'' R_d^2}{\rho_g(r) r^2}
     ]
   * m'' > 0 时，v(r) 与 +r 方向同向：**Stefan 流向外吹**。

2. 实现要求

   * 任何使用 v(r) 的地方（对流项构造）必须保持：

     * m'' > 0 ⇒ v(r) > 0（远离液滴）
   * 对流通量一律采用：
     [
     F_{\text{conv},f} = \rho_g v_f \phi_f A_f
     ]
     并遵守“流出为正”的 cell 残差约定。

---

## 9. 接口相关模块的强制约束（给 interface_bc.py / radius_eq.py 用）

为了后续不再出现“不同模块各搞一套符号体系”的灾难，对两个关键模块额外加几条死规矩：

1. `physics/interface_bc.py`

   * 使用的所有通量（q_g, q_l, J_g,k）必须按上面约定的方向与定义直接读取，**禁止在本模块内做“修正符号”的小动作**；
   * 界面质量残差行必须与：
     [
     \sum_k J_{g,k}\cdot n + m'' = 0
     ]
     在符号上保持完全一致；
   * 界面能量残差行必须与：
     [
     q_l \cdot n - q_g \cdot n + \sum_k h_{k,g} J_{g,k}\cdot n - m'' h_{\text{vap}} = 0
     ]
     的符号结构保持一致；
   * Ts 若作为独立未知量，出现在界面方程中的系数，必须遵守上述物理表达式的线性化，不允许凭感觉加减号。

2. `physics/radius_eq.py`

   * 构建的 R_d 残差行在极限情况下应能约化为：
     [
     \frac{R_d^{n+1} - R_d^n}{\Delta t} + \frac{m''^{n+1}}{\bar{\rho}_l} = 0
     ]
     或与此等价的形式；
   * 蒸发条件下（m'' > 0）求解得到的 R_d^{n+1} 必须小于 R_d^n，反之同理。

---

## 10. 一句话结论

* 法向：**永远是 n = +e_r，从液滴指向外界**；
* 约定：**流出为正**，q = −λ dT/dr，J 按 +r 为正，m'' > 0 为蒸发，dR_d/dt 与 m'' 的符号通过质量守恒锁死；
* 要求：任何模块发现自己需要“多加一个负号才能对”，先怀疑的是自己，而不是“物理这么规定的”。

这份文件就是后面写 `interface_bc.py` 时的底线约束，Codex 敲坏了就怪你不给它立规矩。


## 附：扩散通量 vs 总通量（Step16 对齐）

- 扩散校正通量 j_corr 已经强制满足 Σ j_corr = 0。
- 总物种通量统一为：J_k = m'' · Y_k + j_corr_k，因此 Σ J_k = m''（m''>0 为蒸发，m''<0 为凝结）。
- 按“流出为正”，任意 cell 方程的散度项使用 div = A_R J_R - A_L J_L。对气相第一个 cell，界面在左面，只有界面通量时 div_if = -A_if J_if。若在线性系统中将此项移到右端 b，应有  += -div_if = +A_if J_if，切勿随手再加负号。
